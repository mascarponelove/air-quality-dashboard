<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Dashboard - Punjab, Rajasthan & Uttar Pradesh</title>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 20px;
        }

        .state-select, .city-select, .refresh-btn {
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .state-select, .city-select {
            background: white;
            min-width: 200px;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            font-weight: 600;
        }

        .refresh-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .last-update {
            color: #666;
            font-size: 0.9rem;
            margin-left: auto;
        }

        .progress-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .progress-text {
            color: #666;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
        }

        .stat-indicator {
            height: 6px;
            border-radius: 3px;
            margin-top: 15px;
        }

        .stations-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .stations-container h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .stations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .station-card {
            border-radius: 12px;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .station-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .station-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
            flex: 1;
        }

        .station-aqi-badge {
            font-size: 2rem;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
            min-width: 80px;
        }

        .station-category {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .station-pollutants {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .pollutant-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .pollutant-label {
            font-size: 0.75rem;
            color: #666;
            font-weight: 600;
        }

        .pollutant-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-top: 3px;
        }

        .station-update {
            margin-top: 12px;
            font-size: 0.85rem;
            color: #666;
            text-align: right;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .chart-card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .health-advisory {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .health-advisory h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .advisory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .advisory-card {
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid;
        }

        .advisory-card h3 {
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .advisory-card ul {
            list-style: none;
            padding: 0;
        }

        .advisory-card li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }

        .advisory-card li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 10px;
            font-weight: bold;
        }

        .healthy-group {
            background: #f0f9ff;
            border-left-color: #3b82f6;
        }

        .vulnerable-group {
            background: #fef3c7;
            border-left-color: #f59e0b;
        }

        .sensitive-group {
            background: #fee2e2;
            border-left-color: #ef4444;
        }

        .legend {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .legend-item {
            padding: 15px;
            border-radius: 10px;
            border: 3px solid;
        }

        .legend-category {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .legend-range {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.5rem;
        }

        .error-message {
            background: #fee;
            border: 2px solid #fcc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            color: #c33;
        }

        .warning-message {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #92400e;
        }

        .footer {
            text-align: center;
            color: white;
            padding: 20px;
            margin-top: 30px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .fire-data-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .fire-data-container h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fire-alert {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .fire-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .fire-stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .fire-stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .fire-stat-value {
            font-size: 2rem;
            font-weight: bold;
        }

        .fire-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .fire-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .fire-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .fire-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .fire-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .fire-table tbody tr:hover {
            background: #f8f9fa;
        }

        .fire-count-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
        }

        .fire-high {
            background: #ff4757;
        }

        .fire-medium {
            background: #ffa502;
        }

        .fire-low {
            background: #2ed573;
        }

        .fire-none {
            background: #57606f;
        }

        .data-source-info {
            margin-top: 15px;
            padding: 15px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 5px;
            font-size: 0.9rem;
            color: #1976d2;
        }

        .update-fire-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .update-fire-btn:hover {
            background: #ee5a6f;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .charts-grid, .stations-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }

            .advisory-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåç Punjab, Rajasthan & Uttar Pradesh Air Quality Dashboard</h1>
            <p>Real-time CPCB air quality monitoring | Including Delhi & Chandigarh NCR | Multiple Stations per City | Stubble Burning Detection</p>
            
            <div class="controls">
                <select id="stateSelect" class="state-select">
                    <option value="punjab">Punjab</option>
                    <option value="rajasthan">Rajasthan</option>
                    <option value="uttar-pradesh">Uttar Pradesh</option>
                    <option value="delhi-chandigarh">Delhi & Chandigarh</option>
                </select>
                
                <select id="citySelect" class="city-select">
                    <!-- Cities will be populated dynamically -->
                </select>
                
                <button id="refreshBtn" class="refresh-btn">üîÑ Refresh Data</button>
                
                <span id="lastUpdate" class="last-update"></span>
            </div>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div id="warningMessage" class="warning-message" style="display: none;"></div>
        
        <div id="progressContainer" class="progress-container" style="display: none;">
            <h3 style="margin-bottom: 10px; color: #333;">Loading Station Data...</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%;">0%</div>
            </div>
            <div id="progressText" class="progress-text">Initializing...</div>
        </div>

        <div id="mainContent" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">City Average AQI</div>
                    <div class="stat-value" id="currentAqi">--</div>
                    <div class="stat-indicator" id="currentAqiBar"></div>
                    <div style="margin-top: 10px; color: #666; font-size: 0.85rem;" id="stationCount">--</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Air Quality Status</div>
                    <div class="stat-value" style="font-size: 1.8rem;" id="aqiCategory">--</div>
                    <div style="margin-top: 10px; color: #666;" id="dominantPollutant">--</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Worst Station AQI</div>
                    <div class="stat-value" id="worstAqi">--</div>
                    <div style="margin-top: 10px; color: #666; font-size: 0.85rem;" id="worstStation">--</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Best Station AQI</div>
                    <div class="stat-value" id="bestAqi">--</div>
                    <div style="margin-top: 10px; color: #666; font-size: 0.85rem;" id="bestStation">--</div>
                </div>
            </div>

            <div class="stations-container">
                <h2>üìç All Monitoring Stations in <span id="cityNameDisplay"></span></h2>
                <div class="stations-grid" id="stationsGrid">
                    <!-- Station cards will be populated here -->
                </div>
            </div>

            <div class="health-advisory">
                <h2>üè• Health Advisory</h2>
                <p style="color: #666; margin-bottom: 15px;">Based on city average AQI: <strong id="advisoryAQI">--</strong> (<span id="advisoryCategory">--</span>)</p>
                <div class="advisory-grid" id="advisoryGrid">
                    <!-- Advisory cards will be populated here -->
                </div>
            </div>

            <div class="fire-data-container" id="fireDataContainer" style="display: none;">
                <h2>üî• Stubble Burning Detection - VIIRS Satellite Data</h2>
                
                <div class="fire-alert" id="fireAlert" style="display: none;">
                    ‚ö†Ô∏è Active stubble burning detected! This significantly contributes to air pollution in the region.
                </div>

                <div class="fire-stats-grid" id="fireStatsGrid">
                    <!-- Fire statistics will be populated here -->
                </div>

                <div class="fire-table-container">
                    <table class="fire-table" id="fireTable">
                        <thead>
                            <tr>
                                <th>District</th>
                                <th>State</th>
                                <th>Fire Count (Last 7 Days)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="fireTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div class="data-source-info">
                    <strong>üì° Data Source:</strong> NASA FIRMS - VIIRS Active Fire Detection (Last 7 days)<br>
                    <strong>üõ∞Ô∏è Satellite:</strong> NOAA-20/JPSS-1 VIIRS Sensor<br>
                    <strong>üìç Coverage:</strong> Punjab & Haryana<br>
                    <strong>‚è±Ô∏è Update Frequency:</strong> Daily (satellite overpass data)
                </div>

                <button class="update-fire-btn" onclick="loadFireData()">üîÑ Refresh Fire Data</button>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h2>Average Pollutant Levels Across All Stations</h2>
                    <canvas id="pollutantsChart"></canvas>
                </div>
                
                <div class="chart-card">
                    <h2>AQI Comparison - All Stations</h2>
                    <canvas id="stationsComparisonChart"></canvas>
                </div>
            </div>

            <div class="legend">
                <h2>AQI Categories (CPCB Standards)</h2>
                <div class="legend-grid">
                    <div class="legend-item" style="border-color: #00E400; background-color: rgba(0, 228, 0, 0.1);">
                        <div class="legend-category" style="color: #006400;">Good</div>
                        <div class="legend-range">0 - 50</div>
                    </div>
                    <div class="legend-item" style="border-color: #FFD700; background-color: rgba(255, 215, 0, 0.1);">
                        <div class="legend-category" style="color: #8B7500;">Satisfactory</div>
                        <div class="legend-range">51 - 100</div>
                    </div>
                    <div class="legend-item" style="border-color: #FF7E00; background-color: rgba(255, 126, 0, 0.1);">
                        <div class="legend-category" style="color: #CC6500;">Moderate</div>
                        <div class="legend-range">101 - 200</div>
                    </div>
                    <div class="legend-item" style="border-color: #FF0000; background-color: rgba(255, 0, 0, 0.1);">
                        <div class="legend-category" style="color: #CC0000;">Poor</div>
                        <div class="legend-range">201 - 300</div>
                    </div>
                    <div class="legend-item" style="border-color: #99004C; background-color: rgba(153, 0, 76, 0.1);">
                        <div class="legend-category" style="color: #99004C;">Very Poor</div>
                        <div class="legend-range">301 - 400</div>
                    </div>
                    <div class="legend-item" style="border-color: #7E0023; background-color: rgba(126, 0, 35, 0.1);">
                        <div class="legend-category" style="color: #7E0023;">Severe</div>
                        <div class="legend-range">401 - 500</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Data sourced from World Air Quality Index Project & CPCB | Fire data from NASA FIRMS</p>
            <p>Real-time monitoring ‚Ä¢ Punjab, Rajasthan, Uttar Pradesh, Delhi & Chandigarh ‚Ä¢ Multiple stations per city ‚Ä¢ Stubble burning detection ‚Ä¢ Updates every 15 minutes</p>
        </div>
    </div>

    <script>
        // Configuration - Token extracted from provided code
        const WAQI_TOKEN = '486994a34df29107945c8a194da64d15218daf77';
        const API_BASE = 'https://api.waqi.info';
        const REQUEST_DELAY = 1000; // 1 second delay between requests to avoid rate limiting
        const MAX_RETRIES = 2; // Retry failed requests
        
        let pollutantsChart = null;
        let stationsChart = null;
        let isLoading = false;

        // Sample fire data
        const SAMPLE_FIRE_DATA = {
            lastUpdated: "2024-10-15",
            data: [
                { district: "Sangrur", state: "Punjab", fireCount: 245 },
                { district: "Bathinda", state: "Punjab", fireCount: 189 },
                { district: "Mansa", state: "Punjab", fireCount: 167 },
                { district: "Patiala", state: "Punjab", fireCount: 143 },
                { district: "Barnala", state: "Punjab", fireCount: 128 },
                { district: "Ludhiana", state: "Punjab", fireCount: 95 },
                { district: "Fatehgarh Sahib", state: "Punjab", fireCount: 87 },
                { district: "Moga", state: "Punjab", fireCount: 76 },
                { district: "Faridkot", state: "Punjab", fireCount: 54 },
                { district: "Amritsar", state: "Punjab", fireCount: 43 },
                { district: "Kaithal", state: "Haryana", fireCount: 98 },
                { district: "Karnal", state: "Haryana", fireCount: 87 },
                { district: "Kurukshetra", state: "Haryana", fireCount: 76 },
                { district: "Ambala", state: "Haryana", fireCount: 65 },
                { district: "Yamunanagar", state: "Haryana", fireCount: 54 },
                { district: "Panipat", state: "Haryana", fireCount: 43 },
                { district: "Sonipat", state: "Haryana", fireCount: 32 }
            ]
        };

        const FIRE_DATA_URL = window.location.hostname.includes('github.io') 
            ? `${window.location.origin}${window.location.pathname}data/fire_data.json`.replace('//', '/')
            : null;

        async function loadFireData() {
            try {
                let fireData;
                
                if (FIRE_DATA_URL) {
                    const response = await fetch(FIRE_DATA_URL);
                    fireData = await response.json();
                } else {
                    fireData = SAMPLE_FIRE_DATA;
                }

                displayFireData(fireData);
            } catch (error) {
                console.error('Error loading fire data:', error);
                displayFireData(SAMPLE_FIRE_DATA);
            }
        }

        function displayFireData(fireData) {
            const selectedState = document.getElementById('stateSelect').value;
            
            if (selectedState === 'punjab' || selectedState === 'delhi-chandigarh') {
                document.getElementById('fireDataContainer').style.display = 'block';
            } else {
                document.getElementById('fireDataContainer').style.display = 'none';
                return;
            }

            const punjabData = fireData.data.filter(d => d.state === 'Punjab');
            const haryanaData = fireData.data.filter(d => d.state === 'Haryana');
            
            const punjabTotal = punjabData.reduce((sum, d) => sum + d.fireCount, 0);
            const haryanaTotal = haryanaData.reduce((sum, d) => sum + d.fireCount, 0);
            const grandTotal = punjabTotal + haryanaTotal;

            if (grandTotal > 100) {
                document.getElementById('fireAlert').style.display = 'block';
            } else {
                document.getElementById('fireAlert').style.display = 'none';
            }

            const statsGrid = document.getElementById('fireStatsGrid');
            statsGrid.innerHTML = `
                <div class="fire-stat-card">
                    <div class="fire-stat-label">Total Fires (7 days)</div>
                    <div class="fire-stat-value">${grandTotal}</div>
                </div>
                <div class="fire-stat-card">
                    <div class="fire-stat-label">Punjab Fires</div>
                    <div class="fire-stat-value">${punjabTotal}</div>
                </div>
                <div class="fire-stat-card">
                    <div class="fire-stat-label">Haryana Fires</div>
                    <div class="fire-stat-value">${haryanaTotal}</div>
                </div>
                <div class="fire-stat-card">
                    <div class="fire-stat-label">Affected Districts</div>
                    <div class="fire-stat-value">${fireData.data.length}</div>
                </div>
            `;

            const sortedData = [...fireData.data].sort((a, b) => b.fireCount - a.fireCount);
            const tableBody = document.getElementById('fireTableBody');
            tableBody.innerHTML = '';

            sortedData.forEach(district => {
                const row = document.createElement('tr');
                
                let statusBadge, statusClass;
                if (district.fireCount > 100) {
                    statusBadge = 'Very High';
                    statusClass = 'fire-high';
                } else if (district.fireCount > 50) {
                    statusBadge = 'High';
                    statusClass = 'fire-medium';
                } else if (district.fireCount > 0) {
                    statusBadge = 'Moderate';
                    statusClass = 'fire-low';
                } else {
                    statusBadge = 'None';
                    statusClass = 'fire-none';
                }

                row.innerHTML = `
                    <td><strong>${district.district}</strong></td>
                    <td>${district.state}</td>
                    <td><strong style="color: #e74c3c;">${district.fireCount}</strong></td>
                    <td><span class="fire-count-badge ${statusClass}">${statusBadge}</span></td>
                `;
                
                tableBody.appendChild(row);
            });

            const dataSourceInfo = document.querySelector('.data-source-info');
            dataSourceInfo.innerHTML = `
                <strong>üì° Data Source:</strong> NASA FIRMS - VIIRS Active Fire Detection (Last 7 days)<br>
                <strong>üõ∞Ô∏è Satellite:</strong> NOAA-20/JPSS-1 VIIRS Sensor<br>
                <strong>üìç Coverage:</strong> Punjab & Haryana<br>
                <strong>‚è±Ô∏è Last Updated:</strong> ${fireData.lastUpdated || 'N/A'}<br>
                <strong>üî• Total Active Fire Detections:</strong> ${grandTotal}
            `;
        }

        const STATES_DATA = {
            'punjab': {
                name: 'Punjab',
                cities: [
                    { name: 'Amritsar', stations: ['amritsar'] },
                    { name: 'Ludhiana', stations: ['ludhiana'] },
                    { name: 'Jalandhar', stations: ['jalandhar'] },
                    { name: 'Patiala', stations: ['patiala'] },
                    { name: 'Bathinda', stations: ['bathinda'] },
                    { name: 'Mandi Gobindgarh', stations: ['mandi-gobindgarh'] },
                    { name: 'Khanna', stations: ['khanna'] },
                    { name: 'Pathankot', stations: ['pathankot'] },
                    { name: 'Rupnagar', stations: ['rupnagar'] }
                ]
            },
            'rajasthan': {
                name: 'Rajasthan',
                cities: [
                    { name: 'Jaipur', stations: ['jaipur'] },
                    { name: 'Jodhpur', stations: ['jodhpur'] },
                    { name: 'Udaipur', stations: ['udaipur'] },
                    { name: 'Kota', stations: ['kota'] },
                    { name: 'Ajmer', stations: ['ajmer'] },
                    { name: 'Alwar', stations: ['alwar'] },
                    { name: 'Bhiwadi', stations: ['bhiwadi'] },
                    { name: 'Pali', stations: ['pali'] },
                    { name: 'Bikaner', stations: ['bikaner'] }
                ]
            },
            'uttar-pradesh': {
                name: 'Uttar Pradesh',
                cities: [
                    { name: 'Lucknow', stations: ['lucknow'] },
                    { name: 'Kanpur', stations: ['kanpur'] },
                    { name: 'Agra', stations: ['agra'] },
                    { name: 'Varanasi', stations: ['varanasi'] },
                    { name: 'Noida', stations: ['noida'] },
                    { name: 'Ghaziabad', stations: ['ghaziabad'] },
                    { name: 'Meerut', stations: ['meerut'] },
                    { name: 'Greater Noida', stations: ['greater-noida'] },
                    { name: 'Moradabad', stations: ['moradabad'] },
                    { name: 'Bareilly', stations: ['bareilly'] },
                    { name: 'Prayagraj', stations: ['prayagraj'] },
                    { name: 'Gorakhpur', stations: ['gorakhpur'] }
                ]
            },
            'delhi-chandigarh': {
                name: 'Delhi & Chandigarh',
                cities: [
                    { 
                        name: 'Delhi', 
                        stations: [
                            'delhi/us-embassy',
                            'delhi/anand-vihar',
                            'delhi/dwarka',
                            'delhi/ito',
                            'delhi/rohini'
                        ] 
                    },
                    { name: 'Chandigarh', stations: ['chandigarh'] }
                ]
            }
        };

        function getAQIColor(aqi) {
            if (aqi <= 50) return '#00E400';
            if (aqi <= 100) return '#FFD700';
            if (aqi <= 200) return '#FF7E00';
            if (aqi <= 300) return '#FF0000';
            if (aqi <= 400) return '#99004C';
            return '#7E0023';
        }
        
        function getAQITextColor(aqi) {
            if (aqi <= 50) return '#006400';
            if (aqi <= 100) return '#8B7500';
            if (aqi <= 200) return '#CC6500';
            if (aqi <= 300) return '#CC0000';
            if (aqi <= 400) return '#99004C';
            return '#7E0023';
        }

        function getAQICategory(aqi) {
            if (aqi <= 50) return 'Good';
            if (aqi <= 100) return 'Satisfactory';
            if (aqi <= 200) return 'Moderate';
            if (aqi <= 300) return 'Poor';
            if (aqi <= 400) return 'Very Poor';
            return 'Severe';
        }

        function getHealthAdvisories(aqi) {
            if (aqi <= 50) {
                return {
                    healthy: {
                        title: "üë§ Healthy People",
                        icon: "üèÉ",
                        advice: [
                            "Good day to be active outside",
                            "No precautions required",
                            "Ideal for outdoor activities and exercise"
                        ]
                    },
                    vulnerable: {
                        title: "üë®‚Äçüë©‚Äçüëß Elderly, Pregnant Women & Children",
                        icon: "üë∂",
                        advice: [
                            "Poses little or no health risk",
                            "Good day to be active outside",
                            "No restrictions on outdoor activities"
                        ]
                    },
                    sensitive: {
                        title: "ü´Å People with Lung & Heart Diseases",
                        icon: "‚ù§Ô∏è",
                        advice: [
                            "Poses little or no health risk",
                            "Good day to be active outside",
                            "Safe for regular activities"
                        ]
                    }
                };
            } else if (aqi <= 100) {
                return {
                    healthy: {
                        title: "üë§ Healthy People",
                        icon: "üèÉ",
                        advice: [
                            "No precautions required",
                            "Safe for outdoor activities",
                            "Minimal impact expected"
                        ]
                    },
                    vulnerable: {
                        title: "üë®‚Äçüë©‚Äçüëß Elderly, Pregnant Women & Children",
                        icon: "üë∂",
                        advice: [
                            "Minor breathing discomfort to sensitive people",
                            "Reduce prolonged or heavy exertion",
                            "Limit prolonged outdoor exertion during peak AQI"
                        ]
                    },
                    sensitive: {
                        title: "ü´Å People with Lung & Heart Diseases",
                        icon: "‚ù§Ô∏è",
                        advice: [
                            "Reduce prolonged or heavy exertion",
                            "Limit prolonged physical exertion during peaks",
                            "Consider reducing outdoor activities if symptoms occur"
                        ]
                    }
                };
            } else if (aqi <= 200) {
                return {
                    healthy: {
                        title: "üë§ Healthy People",
                        icon: "üèÉ",
                        advice: [
                            "Limit outdoor activities during peak AQI",
                            "Reduce prolonged or heavy exertion",
                            "Consider indoor exercise alternatives"
                        ]
                    },
                    vulnerable: {
                        title: "üë®‚Äçüë©‚Äçüëß Elderly, Pregnant Women & Children",
                        icon: "üë∂",
                        advice: [
                            "Breathing discomfort to sensitive people",
                            "Reduce prolonged or heavy exertion",
                            "Avoid prolonged outdoor activities",
                            "People with heart disease avoid sources of PM"
                        ]
                    },
                    sensitive: {
                        title: "ü´Å People with Lung & Heart Diseases",
                        icon: "‚ù§Ô∏è",
                        advice: [
                            "Limit activities in polluted areas",
                            "Avoid heavy traffic and pollution sources",
                            "Re-schedule outdoor activities per AQI level",
                            "Reduce prolonged or heavy exertion"
                        ]
                    }
                };
            } else if (aqi <= 300) {
                return {
                    healthy: {
                        title: "üë§ Healthy People",
                        icon: "üèÉ",
                        advice: [
                            "Reduce prolonged or heavy exertion",
                            "Breathing discomfort may occur",
                            "Consider moving activities indoors",
                            "Wear N95 mask if going outdoors"
                        ]
                    },
                    vulnerable: {
                        title: "üë®‚Äçüë©‚Äçüëß Elderly, Pregnant Women & Children",
                        icon: "üë∂",
                        advice: [
                            "Avoid prolonged or heavy exertion",
                            "Stay indoors as much as possible",
                            "Use air purifiers indoors",
                            "Wear N95 mask if must go outside"
                        ]
                    },
                    sensitive: {
                        title: "ü´Å People with Lung & Heart Diseases",
                        icon: "‚ù§Ô∏è",
                        advice: [
                            "Avoid exposure to polluted areas",
                            "Reduce activities & avoid pollution sources",
                            "Stay indoors with air purification",
                            "Consult doctor if symptoms worsen"
                        ]
                    }
                };
            } else if (aqi <= 400) {
                return {
                    healthy: {
                        title: "üë§ Healthy People",
                        icon: "üèÉ",
                        advice: [
                            "Avoid prolonged or heavy exertion",
                            "Move all activities indoors",
                            "Use N95 masks when going outside",
                            "Keep windows and doors closed"
                        ]
                    },
                    vulnerable: {
                        title: "üë®‚Äçüë©‚Äçüëß Elderly, Pregnant Women & Children",
                        icon: "üë∂",
                        advice: [
                            "Avoid all physical activities outdoors",
                            "Stay indoors with air purifiers",
                            "Keep children indoors",
                            "Seek medical advice if needed"
                        ]
                    },
                    sensitive: {
                        title: "ü´Å People with Lung & Heart Diseases",
                        icon: "‚ù§Ô∏è",
                        advice: [
                            "Avoid all physical activities outdoors",
                            "Keep prescribed medications readily available",
                            "Seek immediate medical help if symptoms appear",
                            "Use air purifiers indoors continuously"
                        ]
                    }
                };
            } else {
                return {
                    healthy: {
                        title: "üë§ Healthy People",
                        icon: "üèÉ",
                        advice: [
                            "‚ö†Ô∏è SERIOUS HEALTH EFFECTS",
                            "Avoid all outdoor activities",
                            "Stay indoors with doors/windows closed",
                            "Use N95 masks even for short outdoor exposure",
                            "Emergency advisory in effect"
                        ]
                    },
                    vulnerable: {
                        title: "üë®‚Äçüë©‚Äçüëß Elderly, Pregnant Women & Children",
                        icon: "üë∂",
                        advice: [
                            "‚ö†Ô∏è EMERGENCY - SERIOUS HEALTH EFFECTS",
                            "Avoid all physical activities outdoors",
                            "Keep children strictly indoors",
                            "Seek medical advice immediately if symptoms occur"
                        ]
                    },
                    sensitive: {
                        title: "ü´Å People with Lung & Heart Diseases",
                        icon: "‚ù§Ô∏è",
                        advice: [
                            "‚ö†Ô∏è MEDICAL EMERGENCY RISK",
                            "Serious health effects - avoid all outdoor exposure",
                            "Keep all medications readily available",
                            "Contact healthcare provider immediately if any symptoms"
                        ]
                    }
                };
            }
        }

        function updateHealthAdvisory(aqi) {
            document.getElementById('advisoryAQI').textContent = Math.round(aqi);
            document.getElementById('advisoryCategory').textContent = getAQICategory(aqi);
            document.getElementById('advisoryCategory').style.color = getAQITextColor(aqi);

            const advisories = getHealthAdvisories(aqi);
            const advisoryGrid = document.getElementById('advisoryGrid');
            
            advisoryGrid.innerHTML = `
                <div class="advisory-card healthy-group">
                    <h3><span style="font-size: 1.5rem;">${advisories.healthy.icon}</span> ${advisories.healthy.title}</h3>
                    <ul>
                        ${advisories.healthy.advice.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
                <div class="advisory-card vulnerable-group">
                    <h3><span style="font-size: 1.5rem;">${advisories.vulnerable.icon}</span> ${advisories.vulnerable.title}</h3>
                    <ul>
                        ${advisories.vulnerable.advice.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
                <div class="advisory-card sensitive-group">
                    <h3><span style="font-size: 1.5rem;">${advisories.sensitive.icon}</span> ${advisories.sensitive.title}</h3>
                    <ul>
                        ${advisories.sensitive.advice.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function updateCityDropdown() {
            const selectedState = document.getElementById('stateSelect').value;
            const stateData = STATES_DATA[selectedState];
            const citySelect = document.getElementById('citySelect');
            
            citySelect.innerHTML = '';
            stateData.cities.forEach((city, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = city.name;
                citySelect.appendChild(option);
            });
        }

        function updateProgress(current, total, stationName) {
            const percentage = Math.round((current / total) * 100);
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = percentage + '%';
            progressFill.textContent = percentage + '%';
            progressText.textContent = `Loading station ${current} of ${total}: ${stationName}`;
        }

        async function fetchStationData(stationId, retryCount = 0) {
            try {
                console.log(`Fetching data for station: ${stationId}`);
                const response = await fetch(`${API_BASE}/feed/${stationId}/?token=${WAQI_TOKEN}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'ok' && data.data && data.data.aqi) {
                    console.log(`‚úì Success: ${stationId} - AQI: ${data.data.aqi}`);
                    return {
                        success: true,
                        stationId: stationId,
                        data: data.data
                    };
                } else {
                    console.warn(`‚úó No data: ${stationId} - Status: ${data.status}`);
                    return {
                        success: false,
                        stationId: stationId,
                        error: data.data || 'No AQI data available'
                    };
                }
            } catch (error) {
                console.error(`‚úó Error: ${stationId} - ${error.message}`);
                
                if (retryCount < MAX_RETRIES) {
                    console.log(`Retrying ${stationId}... (Attempt ${retryCount + 1}/${MAX_RETRIES})`);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    return fetchStationData(stationId, retryCount + 1);
                }
                
                return {
                    success: false,
                    stationId: stationId,
                    error: error.message
                };
            }
        }

        async function fetchAllStationsData(stations) {
            const results = [];
            const total = stations.length;
            
            console.log(`Starting to fetch ${total} stations sequentially...`);
            
            for (let i = 0; i < stations.length; i++) {
                updateProgress(i + 1, total, stations[i]);
                
                const result = await fetchStationData(stations[i]);
                if (result.success) {
                    results.push(result);
                }
                
                if (i < stations.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, REQUEST_DELAY));
                }
            }
            
            console.log(`Fetch complete: ${results.length}/${total} stations successful`);
            return results;
        }

        function displayStationCards(stationsData) {
            const stationsGrid = document.getElementById('stationsGrid');
            
            if (stationsData.length === 0) {
                stationsGrid.innerHTML = '<div class="no-data">No monitoring station data available for this city</div>';
                return;
            }

            stationsGrid.innerHTML = '';
            
            stationsData.forEach(station => {
                const data = station.data;
                const aqi = data.aqi;
                const category = getAQICategory(aqi);
                const color = getAQIColor(aqi);
                const textColor = getAQITextColor(aqi);
                
                const stationCard = document.createElement('div');
                stationCard.className = 'station-card';
                
                const iaqi = data.iaqi || {};
                const stationName = data.city?.name || station.stationId;
                
                stationCard.innerHTML = `
                    <div class="station-header">
                        <div class="station-name">${stationName}</div>
                    </div>
                    <div style="text-align: center; margin: 15px 0;">
                        <div class="station-aqi-badge" style="background-color: ${color};">${aqi}</div>
                        <div class="station-category" style="color: ${textColor};">${category}</div>
                    </div>
                    <div class="station-pollutants">
                        <div class="pollutant-item">
                            <div class="pollutant-label">PM2.5</div>
                            <div class="pollutant-value">${iaqi.pm25?.v || '--'}</div>
                        </div>
                        <div class="pollutant-item">
                            <div class="pollutant-label">PM10</div>
                            <div class="pollutant-value">${iaqi.pm10?.v || '--'}</div>
                        </div>
                        <div class="pollutant-item">
                            <div class="pollutant-label">NO2</div>
                            <div class="pollutant-value">${iaqi.no2?.v || '--'}</div>
                        </div>
                        <div class="pollutant-item">
                            <div class="pollutant-label">SO2</div>
                            <div class="pollutant-value">${iaqi.so2?.v || '--'}</div>
                        </div>
                        <div class="pollutant-item">
                            <div class="pollutant-label">O3</div>
                            <div class="pollutant-value">${iaqi.o3?.v || '--'}</div>
                        </div>
                        <div class="pollutant-item">
                            <div class="pollutant-label">CO</div>
                            <div class="pollutant-value">${iaqi.co?.v || '--'}</div>
                        </div>
                    </div>
                    <div class="station-update">Updated: ${data.time?.s || 'N/A'}</div>
                `;
                
                stationsGrid.appendChild(stationCard);
            });
        }

        function updateStatistics(stationsData) {
            if (stationsData.length === 0) {
                document.getElementById('currentAqi').textContent = '--';
                document.getElementById('aqiCategory').textContent = 'No Data';
                document.getElementById('stationCount').textContent = 'No stations available';
                return;
            }

            const aqiValues = stationsData.map(s => s.data.aqi);
            const avgAqi = aqiValues.reduce((sum, val) => sum + val, 0) / aqiValues.length;
            const category = getAQICategory(avgAqi);
            const color = getAQIColor(avgAqi);
            const textColor = getAQITextColor(avgAqi);

            document.getElementById('currentAqi').textContent = Math.round(avgAqi);
            document.getElementById('currentAqi').style.color = textColor;
            document.getElementById('currentAqiBar').style.backgroundColor = color;
            document.getElementById('stationCount').textContent = `Average from ${stationsData.length} station(s)`;
            
            document.getElementById('aqiCategory').textContent = category;
            document.getElementById('aqiCategory').style.color = textColor;
            
            const worstStation = stationsData.reduce((max, s) => s.data.aqi > max.data.aqi ? s : max);
            const bestStation = stationsData.reduce((min, s) => s.data.aqi < min.data.aqi ? s : min);
            
            document.getElementById('worstAqi').textContent = worstStation.data.aqi;
            document.getElementById('worstAqi').style.color = getAQITextColor(worstStation.data.aqi);
            document.getElementById('worstStation').textContent = worstStation.data.city?.name || worstStation.stationId;
            
            document.getElementById('bestAqi').textContent = bestStation.data.aqi;
            document.getElementById('bestAqi').style.color = getAQITextColor(bestStation.data.aqi);
            document.getElementById('bestStation').textContent = bestStation.data.city?.name || bestStation.stationId;
            
            const dominantPollutant = worstStation.data.dominentpol || 'N/A';
            document.getElementById('dominantPollutant').textContent = 
                `Primary pollutant: ${dominantPollutant.toUpperCase()}`;
        }

        function createPollutantsChart(stationsData) {
            const ctx = document.getElementById('pollutantsChart');
            
            if (pollutantsChart) {
                pollutantsChart.destroy();
            }

            if (stationsData.length === 0) return;

            const pollutantSums = { pm25: 0, pm10: 0, no2: 0, so2: 0, o3: 0, co: 0 };
            const pollutantCounts = { pm25: 0, pm10: 0, no2: 0, so2: 0, o3: 0, co: 0 };

            stationsData.forEach(station => {
                const iaqi = station.data.iaqi || {};
                Object.keys(pollutantSums).forEach(pollutant => {
                    if (iaqi[pollutant]?.v) {
                        pollutantSums[pollutant] += iaqi[pollutant].v;
                        pollutantCounts[pollutant]++;
                    }
                });
            });

            const avgPollutants = {};
            Object.keys(pollutantSums).forEach(pollutant => {
                avgPollutants[pollutant] = pollutantCounts[pollutant] > 0 
                    ? pollutantSums[pollutant] / pollutantCounts[pollutant] 
                    : 0;
            });

            const pollutants = {
                'PM2.5': avgPollutants.pm25,
                'PM10': avgPollutants.pm10,
                'NO2': avgPollutants.no2,
                'SO2': avgPollutants.so2,
                'O3': avgPollutants.o3,
                'CO': avgPollutants.co
            };

            pollutantsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(pollutants),
                    datasets: [{
                        label: 'Average AQI Value',
                        data: Object.values(pollutants),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#4facfe',
                            '#00f2fe',
                            '#43e97b'
                        ],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f0f0f0'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function createStationsComparisonChart(stationsData) {
            const ctx = document.getElementById('stationsComparisonChart');
            
            if (stationsChart) {
                stationsChart.destroy();
            }

            if (stationsData.length === 0) return;

            const stationNames = stationsData.map(s => {
                const name = s.data.city?.name || s.stationId;
                return name.length > 20 ? name.substring(0, 17) + '...' : name;
            });
            const aqiValues = stationsData.map(s => s.data.aqi);
            const colors = aqiValues.map(aqi => getAQIColor(aqi));

            stationsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stationNames,
                    datasets: [{
                        label: 'AQI',
                        data: aqiValues,
                        backgroundColor: colors,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f0f0f0'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        async function updateDashboard() {
            if (isLoading) {
                console.log('Already loading, please wait...');
                return;
            }

            const selectedState = document.getElementById('stateSelect').value;
            const cityIndex = parseInt(document.getElementById('citySelect').value);
            const stateData = STATES_DATA[selectedState];
            const cityData = stateData.cities[cityIndex];
            
            try {
                isLoading = true;
                document.getElementById('refreshBtn').disabled = true;
                document.getElementById('progressContainer').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('warningMessage').style.display = 'none';

                document.getElementById('cityNameDisplay').textContent = cityData.name;

                console.log(`\n=== Fetching data for ${cityData.name} ===`);
                console.log(`Total stations: ${cityData.stations.length}`);
                
                const stationsData = await fetchAllStationsData(cityData.stations);
                
                if (stationsData.length === 0) {
                    throw new Error('No data available from any monitoring station. Please try another city or check back later.');
                }

                const failedCount = cityData.stations.length - stationsData.length;
                if (failedCount > 0) {
                    const warningMsg = document.getElementById('warningMessage');
                    warningMsg.textContent = `‚ö†Ô∏è Note: ${failedCount} out of ${cityData.stations.length} stations could not be reached. Displaying data from ${stationsData.length} available station(s).`;
                    warningMsg.style.display = 'block';
                }

                updateStatistics(stationsData);
                displayStationCards(stationsData);
                
                const avgAqi = stationsData.reduce((sum, s) => sum + s.data.aqi, 0) / stationsData.length;
                updateHealthAdvisory(avgAqi);
                
                createPollutantsChart(stationsData);
                createStationsComparisonChart(stationsData);

                loadFireData();

                document.getElementById('lastUpdate').textContent = 
                    `Last updated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`;
                
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                console.log('=== Dashboard update complete ===\n');
                
            } catch (error) {
                console.error('Dashboard error:', error);
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = 
                    `Error loading data: ${error.message}`;
            } finally {
                isLoading = false;
                document.getElementById('refreshBtn').disabled = false;
            }
        }

        document.getElementById('stateSelect').addEventListener('change', () => {
            updateCityDropdown();
            updateDashboard();
        });
        
        document.getElementById('citySelect').addEventListener('change', updateDashboard);
        document.getElementById('refreshBtn').addEventListener('click', updateDashboard);

        setInterval(updateDashboard, 15 * 60 * 1000);

        updateCityDropdown();
        updateDashboard();
    </script>
</body>
</html>
